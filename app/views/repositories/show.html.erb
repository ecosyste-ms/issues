<% @meta_title = "#{@repository.full_name} issue stats | #{@host}" %>

<div class="container-sm">
  <h1>
    <%= link_to @host, host_path(@host) %> /
      
    <%= link_to @repository.full_name, @repository.html_url, target: :_blank %> issue stats
  </h1>

  <% if @repository.last_synced_at %>
    <p class="card-subtitle mb-2 text-muted"><i><small>
        Last synced: <%= distance_of_time_in_words_to_now @repository.last_synced_at %> ago
    </small></i></p>
    <% if @repository.issues_count %>
      <p>
        Total issues: <%= number_with_delimiter @repository.issues_count %><br>
        Total pull Requests: <%= number_with_delimiter @repository.pull_requests_count %><br><br>
        Average time to close issues: <%= distance_of_time_in_words @repository.avg_time_to_close_issue %><br>
        Average time to close pull requests: <%= distance_of_time_in_words @repository.avg_time_to_close_pull_request %><br><br>
        Total issue authors: <%= number_with_delimiter @repository.issue_authors_count %><br>
        Total pull request authors: <%= number_with_delimiter @repository.pull_request_authors_count %><br><br>
        Average comments per issue: <%= number_with_delimiter @repository.avg_comments_per_issue.round(2) %><br>
        Average comments per pull request: <%= number_with_delimiter @repository.avg_comments_per_pull_request.round(2) %><br><br>

        Bot issues: <%= number_with_delimiter @repository.bot_issues_count %><br>
        Bot pull requests: <%= number_with_delimiter @repository.bot_pull_requests_count %><br><br>

        More repo stats: <%= link_to @repository.repos_url, @repository.repos_url, target: :_blank %><br>
        JSON API: <%= link_to api_v1_host_repository_url(@host, @repository), api_v1_host_repository_url(@host, @repository), target: :_blank %>
      </p>
      <hr>
      <div class='row'>
        <div class='col-md-4'>
          <h4>Issue Author Associations</h4>
          <ul>
            <% @repository.issues.where(pull_request: false).group(:author_association).count.sort_by{|k,v| -v }.each do |author, count| %>
              <li>
                <%= author.humanize %>
                (<%= number_with_delimiter count %>, <%= number_to_percentage count.to_f / @repository.issues_count * 100, precision: 2 %>)
              </li>
            <% end %>
          </ul>
        </div>
        <div class='col-md-4'>
          <h4>Pull Request Author Associations</h4>
          <ul>
            <% @repository.issues.where(pull_request: true).group(:author_association).count.sort_by{|k,v| -v }.each do |author, count| %>
              <li>
                <%= author.humanize %>
                (<%= number_with_delimiter count %>, <%= number_to_percentage count.to_f / @repository.pull_requests_count * 100, precision: 2 %>)
              </li>
            <% end %>
          </ul>
        </div>
      </div>
      <hr>
      <div class='row'>
        <div class='col-md-4'>
          <h4>Top Issue Authors</h4>
          <ul>
            <% @repository.issues.where(pull_request: false).group(:user).count.sort_by{|k,v| -v }.first(15).each do |author, count| %>
              <li>
                <%= author %>
                (<%= number_with_delimiter count %>)
              </li>
            <% end %>
          </ul>
        </div>
        <div class='col-md-4'>
          <h4>Top Pull Request Authors</h4>
          <ul>
            <% @repository.issues.where(pull_request: true).group(:user).count.sort_by{|k,v| -v }.first(15).each do |author, count| %>
              <li>
                <%= author %>
                (<%= number_with_delimiter count %>)
              </li>
            <% end %>
          </ul>
        </div>
      </div>


      <hr>
      <div class='row'>
        <div class='col-md-4'>
          <h4>Top Issue Labels</h4>
          <ul>
            <% @repository.issue_labels_count.first(30).each do |label, count| %>
              <li>
                <%= label %>
                (<%= number_with_delimiter count %>)
              </li>
            <% end %>
          </ul>
        </div>
        <div class='col-md-4'>
          <h4>Top Pull Request Labels</h4>
          <ul>
            <% @repository.pull_request_labels_count.first(30).each do |label, count| %>
              <li>
                <%= label %>
                (<%= number_with_delimiter count %>)
              </li>
            <% end %>
          </ul>
        </div>
      </div>

    <% end %>
  <% else %>
    <p class="card-subtitle mb-2 text-muted"><i><small>
        This repository has not been synced yet.

        <% if @job && @job.in_progress? %>
          <meta http-equiv=refresh content="3; url=<%= request.url %>">
        <% end %>
    </small></i></p>
  <% end %>

  

</div>